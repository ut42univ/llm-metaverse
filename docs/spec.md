# メタバースプラットフォーム 要件定義書（プロトタイプ / WebXR コミュニケーション特化）

ドキュメント版数: v0.1 (初稿)  
作成日: 2025-09-06  
対象リリース: MVP (Phase 1)

## 0. 本書の目的

提供された初期要件を整理・補完し、MVP 開発および後続フェーズ拡張の判断基準となる公式な要件定義を提示する。機能境界・非機能要求・制約・受入基準を明確化し、実装/テスト/運用の共通参照点とする。

## 1. 背景・目的

Web ブラウザ (VR HMD / PC / モバイル) からアクセス可能な軽量 WebXR メタバース空間を構築し、低遅延なプレイヤー状態同期と空間音声による自然な会話体験を提供する。生成 AI によるコミュニケーション支援 (翻訳 / 要約 / 画像生成 / 発話補助) を統合し、言語や表現の壁を軽減する。

## 2. スコープ

### 2.1 含まれる範囲 (MVP)

- 単一ルーム (複数ルーム前提の拡張性は保持) 最大 10 名同時参加
- プレイヤー: 位置 / 回転 / (VR) ハンド / 頭部トラッキング同期
- 簡易ジェスチャー / エモート同期
- 空間音声 (LiveKit) + 音量減衰 (距離ベース)
- ユーザー簡易フォーム (ニックネーム + 任意背景情報) ─ 永続化なし
- 生成 AI による (a) 翻訳 (b) 要約 (c) 画像生成 (d) 会話補助プロンプト
- WebXR / 非 VR (デスクトップ / モバイル) 両対応の 3D シーンレンダリング

### 2.2 未来フェーズ (アウトスコープ: 設計上は考慮)

- リップシンク (フォネム駆動)
- 複数ルーム管理 / ルーム一覧 UI / ルーム検索
- アバターカスタマイズ / 永続プロフィール / 認証基盤
- Redis 等を用いたスケールアウト (必要性発生時)
- ビデオ配信 (現状: 音声のみ)

## 3. 用語定義

| 用語               | 定義                                           |
| ------------------ | ---------------------------------------------- |
| プレイヤー         | ルームに参加するクライアントユーザー           |
| トラッキングデータ | 位置 / 回転 / ハンド / 頭部 (位置・向き・高さ) |
| ジェスチャー       | 事前定義の離散的モーション/エモート            |
| 空間音声           | 位置情報に基づき減衰 / パンニングされた音声    |
| 生成 AI            | 翻訳 / 要約 / 画像生成 / 会話補助 API          |
| MVP                | 最小実用プロトタイプ                           |

## 4. 利用者 / ペルソナ

| ペルソナ         | 要点               | 主要ニーズ                     |
| ---------------- | ------------------ | ------------------------------ |
| VR 参加ユーザー  | Meta Quest 等 HMD  | 自然な動きと低遅延音声         |
| PC/Web ユーザー  | マウス・キーボード | 簡易操作で会話参加             |
| モバイルユーザー | タッチ操作         | 軽量表示と最低限ナビゲーション |
| ファシリテータ   | 小規模会議運営     | 入退室把握・会話円滑化         |

## 5. ユースケース (主要シナリオ)

1. 参加: ユーザーが URL アクセス → ニックネーム入力 → ルーム参加 → 他参加者表示/音声接続。
2. 移動: プレイヤー移動/回転が他クライアントへ <150ms (p95) で反映。
3. VR ジェスチャー: HMD/コントローラのハンドポーズが共有。
4. 会話: LiveKit 音声が距離減衰つきで再生、位置変化に追従。
5. AI 翻訳: 特定言語発話テキスト化(将来)を翻訳表示（MVPでは手動入力テキスト翻訳でも可）。
6. AI 画像生成: ルーム内コンテキスト + プロンプトからサムネ/装飾画像生成しチャットパネル表示。
7. 退出: ユーザー離脱が全員の UI に即時通知 (<500ms)。

## 6. 機能要件 (FR)

| ID    | 要件                          | 優先度 | 受入基準 (抜粋)                              |
| ----- | ----------------------------- | ------ | -------------------------------------------- |
| FR-01 | ルーム参加                    | Must   | 10 人まで拒否されない / 11人目は参加不可通知 |
| FR-02 | ニックネーム入力              | Must   | 空欄禁止 / 1〜24 文字制限                    |
| FR-03 | プレイヤー位置同期            | Must   | p95 150ms 以内伝播 / ジッター平滑            |
| FR-04 | 回転同期                      | Must   | 位置と同一経路で伝播                         |
| FR-05 | ハンドトラッキング同期 (VR時) | Should | 両手 6DoF 又はポーズ ID                      |
| FR-06 | 頭部トラッキング              | Must   | HMD ポーズ → アバター頭部反映                |
| FR-07 | ジェスチャー/エモート送信     | Should | 事前定義 ID をブロードキャスト               |
| FR-08 | 空間音声再生                  | Must   | 距離減衰 + 左右定位正しく反映                |
| FR-09 | 音量距離モデル設定            | Must   | 線形または逆二乗のパラメータ調整可能         |
| FR-10 | 入退室通知                    | Must   | UI トースト or リスト更新 <500ms             |
| FR-11 | 生成 AI 翻訳                  | Should | 入力テキスト → 選択言語 翻訳 <5s             |
| FR-12 | 生成 AI 要約                  | Could  | 直近 N 発話要約 <8s                          |
| FR-13 | 生成 AI 画像生成              | Could  | プロンプト→画像 <20s (外部 API 依存)         |
| FR-14 | 会話補助プロンプト            | Could  | テンプレ提示 & クリック挿入                  |
| FR-15 | ルーム内のみデータ保持        | Must   | ページリロードで消去される                   |
| FR-16 | エラーハンドリング表示        | Must   | ネットワーク断/再接続リカバリ案内            |
| FR-17 | 接続状態インジケータ          | Should | Colyseus, LiveKit 個別状態表示               |

## 7. 非機能要件 (NFR)

| 区分         | ID         | 要件                  | 指標                                                    |
| ------------ | ---------- | --------------------- | ------------------------------------------------------- |
| 性能         | NFR-P01    | 位置同期レイテンシ    | p95 <=150ms (同リージョン)                              |
| 性能         | NFR-P02    | 初回シーンロード      | 3D アセットキャッシュ後 <5s (標準回線)                  |
| 性能         | NFR-P03    | 平均送信帯域/ユーザー | < 80kbps (動き標準, 音声除く)                           |
| 可用性       | NFR-A01    | サービス稼働          | プロトタイプ: 平日開発時間帯稼働優先                    |
| 拡張性       | NFR-S01    | ルーム数拡張          | 将来: Redis アダプタ追加で水平スケール可能              |
| 信頼性       | NFR-R01    | 再接続                | 一時切断 <10s 以内自動再参加                            |
| UX           | NFR-U01    | FPS (VR)              | 72fps 目標 / 最低 45fps フォールバック                  |
| UX           | NFR-U02    | 入力遅延              | 回転追従遅延主観 <80ms                                  |
| セキュリティ | NFR-Sec01  | 通信                  | TLS (WSS/WebRTC)                                        |
| セキュリティ | NFR-Sec02  | 個人情報              | 永続保存なし / ログにニックネーム以外記録しない         |
| プライバシ   | NFR-Priv01 | AI 送信データ         | 必要最小限のテキストのみ / 音声原データ送信禁止(現段階) |
| 運用         | NFR-Ops01  | ログ                  | サーバー: 接続/切断/エラー最小レベル                    |

## 8. 外部インタフェース要件

- ブラウザ: WebXR 対応 (Chromium 系, Quest Browser) / Fallback: 非 VR カメラ操作
- API/サービス: Colyseus (WebSocket), LiveKit (WebRTC), 生成AI (HTTP/REST or gRPC)
- 音声 I/O: マイクアクセス (ユーザー許可) / スピーカー出力
- 権限ダイアログ: マイク / VR セッション開始時

## 9. データ項目定義 (揮発性メモリ内)

| 項目        | 型                             | 説明                        | 補足                  |
| ----------- | ------------------------------ | --------------------------- | --------------------- |
| playerId    | string                         | 一意識別子 (セッション単位) | UUID v4 推奨          |
| nickname    | string                         | 表示名                      | 1-24 文字             |
| profileNote | string?                        | 任意背景                    | 0-140 文字            |
| position    | Vec3(f32)                      | ワールド座標                | m 単位                |
| rotation    | Quaternion(f32x4)              | 姿勢                        | 正規化                |
| headPose    | {pos:Vec3,rot:Quat,height:f32} | HMD                         | height: 推定身長      |
| hands       | {left?:Pose,right?:Pose}       | コントローラ/ハンド         | Pose=位置+回転+状態ID |
| gesture     | enum                           | エモート ID                 | null=未発生           |
| aiContext   | struct                         | ルーム共有簡易情報          | 最小限抽出            |

## 10. 画面/UI 要件 (概要)

| 画面         | 要素             | 要件                          |
| ------------ | ---------------- | ----------------------------- |
| 参加フォーム | ニックネーム入力 | 必須・バリデーション          |
| 3D シーン    | アバター表示     | ロード完了後フェードイン      |
| HUD          | 参加者リスト     | 動的更新 / ミュート状態表示   |
| AI パネル    | 翻訳/要約結果    | タブ切替 / ローディング表示   |
| ステータス   | 接続アイコン     | Colyseus / LiveKit 個別色分け |

## 11. リアルタイム同期仕様 (概要)

| 項目         | 更新頻度         | 伝送方式             | 最適化                        |
| ------------ | ---------------- | -------------------- | ----------------------------- |
| 位置/回転    | 20Hz 目標 (補間) | WebSocket (Colyseus) | Dead reckoning / 補間         |
| ハンド/頭部  | 20Hz             | 同上                 | 圧縮 (Float32→Int16 量子化案) |
| ジェスチャー | イベント駆動     | WebSocket            | 信頼配送                      |
| 入退室       | イベント         | WebSocket            | 即時ブロードキャスト          |

補間: クライアント側で線形/球面線形補間 (最大遅延 100ms バッファ)。

## 12. 空間音声仕様

- LiveKit で各参加者ストリーム取得 → Three.js カメラ基準で PannerNode 更新。
- 減衰モデル (例): rolloffFactor, refDistance=1.0, maxDistance=25.0。
- 更新タイミング: レンダーループ (<=16ms) 毎に listener position/forward を同期。

## 13. 生成 AI 連携仕様

| 機能     | 入力                       | 出力           | タイムアウト | リトライ |
| -------- | -------------------------- | -------------- | ------------ | -------- |
| 翻訳     | テキスト, srcLang, dstLang | 翻訳テキスト   | 8s           | 1 回     |
| 要約     | 直近 N テキスト            | 要約文         | 10s          | 0-1 回   |
| 画像生成 | プロンプト                 | 画像URL/Base64 | 25s          | 1 回     |
| 会話補助 | 直近コンテキスト           | 提案返信候補   | 8s           | 1 回     |

制約: 個人識別情報や生音声文字起こし(未導入)以外は送信可。ログ化はマスク。

## 14. セキュリティ / プライバシ

- 通信は TLS (WSS) / WebRTC DTLS + SRTP
- 永続 DB なし: セッション終了時データ破棄
- AI 連携: 送信前にフィルタリング (禁止語/個人情報トークン抽出は将来検討)
- XSS 対策: 翻訳/要約結果反映時サニタイズ

## 15. 障害対応 / 運用

| イベント           | 対応                                         | ユーザー表示         |
| ------------------ | -------------------------------------------- | -------------------- |
| Colyseus 切断      | 自動再接続 (指数バックオフ 0.5→4s, 最大 30s) | 再接続中インジケータ |
| LiveKit 音声途切れ | 再試行 / ICE Restart                         | 音声接続アイコン変化 |
| AI タイムアウト    | キャンセル & 再試行ボタン                    | エラーメッセージ     |

## 16. スケーラビリティ / 性能設計 (将来拡張指針)

- Colyseus: Node.js インスタンス水平分散 + Redis presence/adaptor
- LiveKit: SFU モード / 複数ノードクラスタリング
- CDN: 3D アセット / 生成画像キャッシュ (将来)
- 負荷試算 (目安): 10 ユーザー _ 20Hz _ (位置+回転 7 float) ≒ 10 _ 20 _ 28 bytes ≒ 5.6KB/s (未圧縮) → 量子化後 ~3KB/s

## 17. 制約 / 前提 / 除外

| 種別 | 内容                                         |
| ---- | -------------------------------------------- |
| 制約 | 1 ルーム最大 10 人                           |
| 制約 | リップシンク未実装 (後追い)                  |
| 前提 | VR HMD (Quest) Chromium ベースブラウザ利用   |
| 除外 | ビデオ配信, 永続プロフィール, 決済, 認証基盤 |

## 18. ロードマップ (案)

| フェーズ | 内容                                             | 期間目安 |
| -------- | ------------------------------------------------ | -------- |
| MVP (P1) | 基本同期 + 空間音声 + 翻訳/要約(最小)            | 4-6 週   |
| P2       | 画像生成 / 会話補助 / パフォーマンステューニング | +3 週    |
| P3       | リップシンク / 複数ルーム / スケールアウト       | 未定     |

## 19. リスク & 緩和策

| リスク             | 影響             | 緩和                                           |
| ------------------ | ---------------- | ---------------------------------------------- |
| WebXR デバイス差異 | 表示/入力不整合  | フィーチャーディテクション + Graceful fallback |
| 帯域不足           | 音声/同期遅延    | 更新頻度動的調整 / 量子化                      |
| AI API レイテンシ  | UX 低下          | ローディング/非同期並列 / キャッシュ           |
| 同期ジッター       | アバター瞬間移動 | クライアント補間/平滑フィルタ                  |
| セッション中断     | 体験中断         | 自動再接続 + 状態再同期プロトコル              |

## 20. 受入基準 (抜粋)

| ID    | 基準                                                    |
| ----- | ------------------------------------------------------- |
| AC-01 | 10 ユーザー同時参加でクラッシュなく 10 分以上稼働       |
| AC-02 | 位置同期 p95 レイテンシ 150ms 以下 (同リージョンテスト) |
| AC-03 | 空間音声で 5m 離隔時の音量が 1m 時の <= 40% (調整可能)  |
| AC-04 | 切断→再接続 (ネットワーク遮断 5s) 後 10s 以内に復帰     |
| AC-05 | 翻訳要求 10 件連続で 90% が 8s 以内完了                 |
| AC-06 | リロードでローカル変数リセット (永続化なし)             |

## 21. トレーサビリティ (概要マッピング)

| ユースケース    | 対応 FR     | 対応 NFR     |
| --------------- | ----------- | ------------ |
| 参加            | FR-01,02,10 | NFR-Sec01    |
| 移動同期        | FR-03,04    | NFR-P01, U02 |
| VR ジェスチャー | FR-05,07    | NFR-P01      |
| 会話            | FR-08,09    | NFR-P01, U01 |
| 翻訳/要約       | FR-11,12    | NFR-P02      |
| 画像生成        | FR-13       | NFR-P02      |
| 再接続          | FR-16,17    | NFR-R01      |

## 22. 想定テクノロジ選定理由 (要約)

| レイヤー   | 採用               | 理由                      |
| ---------- | ------------------ | ------------------------- |
| Next.js    | SSR/ISR + 開発体験 | 迅速な UI 実装            |
| Three.js   | 汎用 3D ライブラリ | WebXR 実績豊富            |
| Colyseus   | ルーム/状態同期    | 状態スキーマ/パッチ最適化 |
| LiveKit    | WebRTC SFU         | 空間音声 / 将来拡張容易   |
| 生成AI API | ベンダ非固定       | 実験的 PoC 柔軟性         |

## 23. オープン課題

| ID    | 課題                                    | 優先度 | 次アクション         |
| ----- | --------------------------------------- | ------ | -------------------- |
| OP-01 | ジェスチャー定義フォーマット            | M      | JSON スキーマ策定    |
| OP-02 | 量子化方式選択 (位置/回転)              | H      | 誤差評価ベンチ作成   |
| OP-03 | 翻訳対象入力の取得方法 (音声→テキスト?) | M      | STT 導入可否調査     |
| OP-04 | 画像生成失敗時の UI プレースホルダ      | M      | デザイン決定         |
| OP-05 | AI コンテキストの最小化指針             | H      | データポリシドラフト |

## 24. 変更管理方針

- 変更要求は GitHub Issue 起票 → ラベル (feature / enhancement / risk) 付与
- 重大変更 (スキーマ/プロトコル) はバージョン番号 (vX.Y) を本書冒頭更新

## 25. 付録 (参考設計パラメータ)

```
位置量子化案: Float32 -> Int16 (range -20m..20m) 分解能 ≈ 0.0006m
回転: Quaternion 正規化後 半精度 (16bit x4) or Axis-Angle (16+16+16+16)
補間ウィンドウ: 2~3 フレーム (≈30〜45ms)
AI レート制限 (暫定): ユーザー毎 画像生成 3/min, 翻訳 30/min
```

---

本書は初稿であり、テスト計画策定時に受入基準・性能指標を細密化する。
